"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const gulp_1 = require("gulp");
const through2 = require("through2");
const rename = require("gulp-rename");
const json_to_ts_1 = require("json-to-ts");
const remote_config_1 = require("./remote-config");
const config = () => {
    // 创建stream对象，每个文件都会经过这个stream对象
    const stream = through2.obj(function (chunk, _, callback) {
        this.push(chunk);
        remote_config_1.RemoteConfig.create(chunk.path)
            .then(rc => {
            chunk.contents = Buffer.from(json_to_ts_1.default(rc.map, { rootName: 'ConfigInterface' })
                .map(s => `export ${s}`)
                .join('\n'));
            callback(null, chunk);
        })
            .catch(e => callback(e.message));
    });
    return stream;
};
const getPath = () => process.argv[process.argv.indexOf('--src') + 1] || 'config/config.dev.yaml';
const path = getPath();
const getConfigInterface = () => {
    return gulp_1.src(path)
        .pipe(config())
        .pipe(rename('config.d.ts'))
        .pipe(gulp_1.dest('src'));
};
gulp_1.task('build:config', getConfigInterface);
//exports.buildConfig = getConfigInterface;
